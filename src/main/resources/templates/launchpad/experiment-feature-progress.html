<div layout:fragment="content" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns:th="http://www.thymeleaf.org"
     xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4"
     layout:decorate="~{/layout-launchpad}"
     th:if="${#bools.isTrue(@environment.getProperty('aiai.launchpad.enabled'))}"
     sec:authorize="isAuthenticated()"
>
    <!--/*@thymesVar id="result" type="aiai.ai.launchpad.experiment.ExperimentsController.SequencesResult"*/-->
    <!--/*@thymesVar id="experiment" type="aiai.ai.beans.Experiment"*/-->
    <!--/*@thymesVar id="feature" type="aiai.ai.beans.ExperimentFeature"*/-->
    <!--/*@thymesVar id="consoleResult" type="aiai.ai.launchpad.experiment.ExperimentsController.ConsoleResult"*/-->
    <!--/*@thymesVar id="params" type="aiai.ai.launchpad.experiment.ExperimentService.HyperParamResult"*/-->
    <!--/*@thymesVar id="metrics" type="aiai.ai.launchpad.experiment.ExperimentService.MetricsResult"*/-->

    <script>
        var /*{boolean}*/ isDebug = true;
        var buttonStateMap = {};
        var buttonAxisStateMap = {};
        var trStateMap = {};
        var metricsStateMap = {};
        var /*{string}*/ paramFilter = ',';
        var /*{string}*/ paramFilterAxis = ',';
        var /*boolean*/ isDrawEnabled = false;


        var table = function (html) {
            var html1 = $('#fragment-table').html(html);

            html1.find('.ajax-elem').each(function () {
                $(this).click(function () {
                    $( '#fragment-console-table' ).empty();
                    trStateMap = {};

                    var /*{string}*/ url = $(this).attr('href');
                    printLogMain('url: ' + url);
                    // /launchpad/experiment-feature-progress-part/82/428/,/part?page=1&size=10
                    var /*{string}*/ urlPart1 = url.substring(0, url.indexOf(',/part'));
                    var /*{string}*/ urlPart = urlPart1.substring(0, urlPart1.lastIndexOf('/'));
                    var /*{string}*/ urlParams = url.substring(url.indexOf('?'));

                    printLogMain('urlPart: ' + urlPart+', urlParam: ' + urlParams);
                    var /*{string}*/ urlFinal = urlPart + '/' + paramFilter + '/part' + urlParams;
                    printLogMain('urlFinal: ' + urlFinal);

                    $.post(urlFinal, table);
                    return false;
                });
            });

            html1.find('.ajax-elem-console').each(function () {
                $(this).click(function () {
                    var $1 = $(this);
                    var origId = $1.attr('id');
                    $.post( $1.attr('href'), function(data ) {
                        $( '#fragment-console-table' ).empty().append( data );
                        $( '#fragment-table' ).find('.ajax-elem-console').each(function () {
                            printLogMain('origId: ' + origId);
                            var $2 = $(this);
                            printLogMain('$(this).id: ' + $2.attr('id'));
                            printLogMain('$(this).class: ' + $2.attr('class'));
                            var newClass = origId===$2.attr('id') ?  'ajax-elem-console table-nav-button pure-button pure-button-selected' : 'ajax-elem-console table-nav-button pure-button';
                            printLogMain('newClass: ' + newClass);
                            $2.attr('class', newClass) ;
                        });
                    });
                    return false;
                });
            });
        };

        $(function () {
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");

            $(document).ajaxSend(function (e, xhr, options) {
                xhr.setRequestHeader(header, token);
            });

            $.post('/launchpad/experiment-feature-progress-part/' + [[${experiment.id}]] + '/' + [[${feature.id}]]+'/,/part', table);
        });

        /**
         * @param {string} trId
         * @param {int} order
         */
        function switchTr(trId, order) {
            printLogTr("trId: " + trId+', order: ' + order+', trStateMap.hasOwnProperty(trId): ' + trStateMap.hasOwnProperty(trId));
            if (!trStateMap.hasOwnProperty(trId)) {
                trStateMap[trId] = order===1 ? 'hide' : 'show';
            }
            var state = trStateMap[trId];
            printLogTr('state : ' + state);
            if (state==='show') {
                $('#'+trId).hide();
                trStateMap[trId] = 'hide'
            }
            else if (state==='hide') {
                $('#'+trId).show();
                trStateMap[trId] = 'show'            }
            else {
                console.warn('Unknown state: ' + state)
            }
            printLogTr('trStateMap[trId] : ' + trStateMap[trId]);
        }

        function switchMetrics() {
            var trId = 'some-id--doesnt-matter-which';
            printLog("metricsStateMap.hasOwnProperty(trId): " + trStateMap.hasOwnProperty(trId));
            if (!metricsStateMap.hasOwnProperty(trId)) {
                metricsStateMap[trId] = 'hide';
            }
            var state = metricsStateMap[trId];
            printLogMetrics('state : ' + state);
            if (state==='show') {
                $('#metrics-main-p').show();
                $('#metrics-main-table').hide();
                metricsStateMap[trId] = 'hide'
            }
            else if (state==='hide') {
                $('#metrics-main-p').hide();
                $('#metrics-main-table').show();
                metricsStateMap[trId] = 'show'            }
            else {
                console.warn('Unknown state: ' + state)
            }
            printLogMetrics('metricsStateMap[trId] : ' + metricsStateMap[trId]);
        }

        /**
         * @param {string} state
         * @param {string} key
         * @param {int} idx
         * @constructor
         */
        function ButtonState(state, key, idx) {
            this.state = state;
            this.key = key;
            this.idx = idx;
        }

        ButtonState.prototype.getState = function() {
            return this.state;
        };

        ButtonState.prototype.getIndex = function() {
            return this.idx;
        };

        ButtonState.prototype.toString = function() {
            return 'ButtonState(state: ' + this.state + ', key: ' +this.key+ ', idx: ' +this.idx+')';
        };

        /**
         * @param {string} id
         * @param {string} key
         */
        function switchButtonAxis(id, key) {
            printLogButtonAxis('id: ' + id);
            if (!buttonAxisStateMap.hasOwnProperty(id)) {
                printLogButtonAxis('#1 buttonStateMap.hasOwnProperty(id): ' + buttonAxisStateMap.hasOwnProperty(id));
                buttonAxisStateMap[id] = new ButtonState('hide', key, 0);
            }
            var buttonState = buttonAxisStateMap[id];
            printLogButtonAxis("#1 buttonState: " + buttonState.toString());
            printLogButtonAxis("buttonState.getState()==='show': " + (buttonState.getState()==='show'));
            printLogButtonAxis("buttonState.getState()==='hide': " + (buttonState.getState()==='hide'));

            var numberSelected = getNumberSelected();
            printLogButtonAxis('numberSelected: ' + numberSelected);
            if (buttonState.getState()==='show') {
                buttonAxisStateMap[id] = new ButtonState('hide', key, 0);
                numberSelected--;
            }
            else if (buttonState.getState()==='hide') {
                if (numberSelected>1) {
                    return;
                }
                buttonAxisStateMap[id] = new ButtonState('show', key, 0);
                numberSelected++;
            }
            else {
                console.warn('Unknown state: ' + buttonState.getState())
            }

            $('#'+id).toggleClass("pure-button-primary");
            isDrawEnabled = (numberSelected===2);
            $('#button-draw-plot').toggleClass("pure-button-primary", (numberSelected===1));
            $('#fragment-console-table' ).empty();
            if (numberSelected>0) {
                paramFilterAxis = paramsForUrlAxis();
            }
            else {
                paramFilterAxis = ',';
            }

            currentState();
            printLogButtonAxis("#2 buttonState: " + buttonState.toString());
            printLogButtonAxis('#2 buttonAxisStateMap.hasOwnProperty(id): ' + buttonAxisStateMap.hasOwnProperty(id));
            printLogButtonAxis('numberSelected: ' + numberSelected);
            printLogButtonAxis('paramFilterAxis: ' + paramFilterAxis);

        }

        function drawPlot() {
            if (isDrawEnabled) {
                var url = '/launchpad/experiment-feature-plot-data-part/' + [[${experiment.id}]] + '/' + [[${feature.id}]] + '/' + paramFilterAxis + '/part';
                $.post(url, function(data ) {

                    x1 = data['x'];
                    y1 = data['y'];
                    z1 = data['z'];

                    var data_plot = {x:x1, y:y1, z: z1, type: 'surface'};

                    // Plotting the surfaces
                    Plotly.newPlot('plot-place', [data_plot], layout);
                });
            }
        }

        /**
         * @param {string} id
         * @param {string} key
         * @param {int} idx
         */
        function switchButton(id, key, idx) {
            printLogButton('id: ' + id + ', key: ' + key + ', idx: ' + idx);
            if (!buttonStateMap.hasOwnProperty(id)) {
                printLogButton('#1 buttonStateMap.hasOwnProperty(id): ' + buttonStateMap.hasOwnProperty(id));
                buttonStateMap[id] = new ButtonState('hide', key, idx);
            }
            var buttonState = buttonStateMap[id];
            var $1 = $('#'+id);
            $1.toggleClass("pure-button-primary");
            printLogButton("#1 buttonState: " + buttonState.toString());
            printLogButton("buttonState.getState()==='show'" + (buttonState.getState()==='show'));
            printLogButton("buttonState.getState()==='hide'" + (buttonState.getState()==='hide'));
            if (buttonState.getState()==='show') {
                buttonStateMap[id] = new ButtonState('hide', key, idx);
            }
            else if (buttonState.getState()==='hide') {
                buttonStateMap[id] = new ButtonState('show', key, idx);
            }
            else {
                console.warn('Unknown state: ' + buttonState.getState())
            }
            printLogButton("#2 buttonState: " + buttonState.toString());
            printLogButton('#2 buttonStateMap.hasOwnProperty(id): ' + buttonStateMap.hasOwnProperty(id));

            $( '#fragment-console-table' ).empty();
            var url;
            var anySelected = isAnySelected();
            printLogButton('anySelected: ' + anySelected+', state: ' + buttonStateMap[id].state + ', idx: ' +buttonStateMap[id].idx);
            if (anySelected) {
                paramFilter = paramsForUrl();
            }
            else {
                paramFilter = ',';
            }
            url = '/launchpad/experiment-feature-progress-part/' + [[${experiment.id}]] + '/' + [[${feature.id}]] + '/' + paramFilter + '/part';
            printLogButton('url: '+ url);
            $.post(url, table);
            printLogButton('');
        }

        /**
         * @param {string} s
         */
        function printLogMain( s ) {
            printLog('MAIN', s );
        }

        /**
         * @param {string} s
         */
        function printLogMetrics( s ) {
            printLog('METRICS', s );
        }

        /**
         * @param {string} s
         */
        function printLogTr( s ) {
            printLog('TR', s );
        }

        /**
         * @param {string} s
         */
        function printLogButton( s ) {
            printLog('BUTTON', s );
        }

        /**
         * @param {string} s
         */
        function printLogButtonAxis( s ) {
            printLog('BUTTON-AXIS', s );
        }

        /**
         * @param {string} tag
         * @param {string} s
         */
        function printLog(tag, s ) {
            if (isDebug) {
                console.log(tag+', '+ s);
            }
        }

        function paramsForUrlAxis() {
            var suffix = '';
            Object.keys(buttonAxisStateMap).forEach(
                function(key) {
                    var buttonState = buttonAxisStateMap[key];
                    if (buttonState.state==='show') {
                        suffix += ( buttonState.key + ',');
                    }
                }
            );
            return suffix;
        }

        function paramsForUrl() {
            var suffix = '';
            Object.keys(buttonStateMap).forEach(
                function(key) {
                    var buttonState = buttonStateMap[key];
                    if (buttonState.state==='show') {
                        suffix += ( buttonState.key + '-' + buttonState.idx + ',');
                    }
                }
            );
            return suffix;
        }

        /**
         * @return {int}
         */
        function getNumberSelected() {
            var num = 0;
            Object.keys(buttonAxisStateMap).forEach(
                function(key) {
                    var buttonState = buttonAxisStateMap[key];
                    if (buttonState.state==='show') {
                        num++;
                    }
                }
            );
            return num;
        }

        function currentState() {
            Object.keys(buttonAxisStateMap).forEach(
                function(key) {
                    var buttonState = buttonAxisStateMap[key];
                    printLogButtonAxis('   key: ' + key+', ' + buttonState.toString()+', state: ' + buttonState.state+', buttonState.getState()===\'show\': ' + (buttonState.state==='show'));
                }
            );
        }

        /**
         * @return {boolean}
         */
        function isAnySelected() {
            var b = false;
            Object.keys(buttonStateMap).forEach(
                function(key) {
                    var buttonState = buttonStateMap[key];
                    printLogButton('   key: ' + key+', ' + buttonState.toString()+', state: ' + buttonState.state+', buttonState.getState()===\'show\': ' + (buttonState.state==='show'));
                    if (buttonState.state==='show') {
                        b = true;
                    }
                }
            );
            return b;
        }

        // Plotly stuff

        x1 = ['A12', 'BC2', 109, 'E57', 'F13', 'G41'];
        y1 = ['D12', 'EC4', 42, 'z01', 'y07', 'x17', 'u87', 't15', 'r91'];

        z1 = [
            [8.75,8.78,8.77,8.91,8.95,8.92],
            [8.8,8.8,8.77,8.91,8.95,8.94],
            [8.74,8.81,8.76,8.93,8.98,8.99],
            [8.89,8.99,8.92,9.1,9.13,9.11],
            [8.97,8.97,8.91,9.09,9.11,9.11],
            [9.04,9.08,9.05,9.25,9.28,9.27],
            [9,9.01,9,9.2,9.23,9.2],
            [8.99,8.99,8.98,9.18,9.2,9.19],
            [8.93,8.97,8.97,9.18,9.2,9.18]
        ];

        var layout = {
            title: 'Ribbon Plot',
            showlegend: false,
            autosize: false,
            width: 800,
            height: 800,
            scene: {
                xaxis: {type: 'category', title: 'Sample #'},
                yaxis: {type: 'category',title: 'Wavelength'},
                zaxis: {title: 'OD'}
            }
        };

    </script>



    <h1 class="widget-header">The experiment info</h1>

    <h1 class="widget-header">General info</h1>
    <table>
        <tr  valign="top">
            <td>
                <table class="pure-table pure-table-bordered">
                    <tbody>
                    <tr><td>#Id</td><td  th:text="${feature.id}">#Id</td></tr>
                    <tr><td>Feature ids</td><td th:text="${feature.featureIds}">featureIds</td></tr>
                    <tr><td>Is in progress?</td><td th:text="${feature.isInProgress}">isInProgress</td></tr>
                    <tr><td>Is in finished?</td><td th:text="${feature.isFinished}">isFinished</td></tr>
                    <tr><td>Exec status</td><td th:text="${feature.execStatusAsString()}">Exec status</td></tr>
                    </tbody>
                </table>
            </td>
            <td width="50">&nbsp;</td>
            <td>
                <table class="pure-table pure-table-bordered">
                    <thead>
                    <tr>
                        <th>Hyper param name</th>
                        <th></th>
                        <th>Hyper param values</th>
                        <th>X,Y axes for plotting</th>
                    </tr>
                    </thead>
                    <tbody>
                        <tr th:each="e, g : ${params.elements}" valign="top">
                            <td th:text="${e.key}">Hyper param key</td>
                            <td width="20">&nbsp;</td>
                            <td th:if="${not e.isSelectable()}" th:text="${e.list[0].param}">Just value</td>
                            <td th:if="${e.isSelectable()}">
                                <table class="pure-table pure-table-bordered">
                                    <tbody>
                                    <tr valign="top">
                                        <div th:remove="tag" th:each="l,idx : ${e.list}" >
                                            <a class='pure-button' href="#"
                                               th:id="${'button-param-'+e.key+'-'+l.param}"
                                               th:onclick="${ 'switchButton(''button-param-'+e.key+'-' + l.param + ''', ''' + e.key + ''', ' + idx.index + ');' }"
                                               title='Hyper param' th:text="${l.param}">param value</a>
                                            &nbsp;
                                        </div>
                                    </tr>
                                    </tbody>
                                </table>
                            </td>
                            <td>
                                <a class='pure-button' href="#" th:id="${'button-axis-'+g.index}"
                                   th:if="${e.list.size()>1}"
                                   th:onclick="${ 'switchButtonAxis(''button-axis-'+g.index + ''', ''' + e.key + ''' );' }"
                                   th:text='Axis'>Axis for plotting</a>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </td>
        </tr>
    </table>
    <p>&nbsp;</p>

    <h1 class="widget-header" th:onclick="${ 'switchMetrics();' }" >Metrics</h1>
    <p id="metrics-main-p">Metrics is hidden</p>
    <table style="display:none" id="metrics-main-table">
        <tr valign="top">
            <td>
                <h1 class="widget-header">As the table</h1>
                <table class="pure-table pure-table-bordered" id="fragment-metrics-value-table" th:fragment="fragment-metrics-value-table">
                    <thead>
                    <tr>
                        <div th:remove="tag" th:each="m, g : ${metrics.metricNames}">
                            <th th:text="${m}">Metric name</th>
                        </div>
                        <th>Hyper params</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="m, g : ${metrics.metrics}" valign="top">
                        <div th:remove="tag" th:each="v : ${m.values}">
                            <td th:text="${v.value}">Metric value</td>
                        </div>
                        <td th:text="${m.params}">Hyper params</td>
                    </tr>
                    <tr>
                        <td th:colspan="${metrics.metrics.size()}">
                            <div th:if="${feature!=null and experiment!=null}">
                                <ul class='pagination pagination-centered'>
                                    <li class="table-nav-padding">
                                        <span th:if='${result.items.first}' class="table-nav-button">« First</span>
                                        <a class='ajax-elem table-nav-button pure-button prev' href="#" th:if='${not result.items.first}'
                                           th:href="@{/launchpad/experiment-feature-progress-part/{experimentId}/{featureId}/,/part(experimentId=${experiment.id},featureId=${feature.id},page=0,size=${result.items.pageable.pageSize})}">« First</a>
                                    </li>
                                    <li class="table-nav-padding">
                                        <span th:if='${not result.items.hasPrevious()}' class="table-nav-button">←</span>
                                        <a class='ajax-elem table-nav-button pure-button prev' href="#" th:if='${result.items.hasPrevious()}'
                                           th:href="@{/launchpad/experiment-feature-progress-part/{experimentId}/{featureId}/,/part(experimentId=${experiment.id},featureId=${feature.id},page=${result.items.pageable.pageNumber - 1},size=${result.items.pageable.pageSize})}" title='Go to previous page'>←</a>
                                    </li>
                                    <li class="table-nav-padding">
                                        <span th:if='${not result.items.hasNext()}' class="table-nav-button">→</span>
                                        <a class='ajax-elem table-nav-button pure-button prev' href="#" th:if='${result.items.hasNext()}'
                                           th:href="@{/launchpad/experiment-feature-progress-part/{experimentId}/{featureId}/,/part(experimentId=${experiment.id},featureId=${feature.id},page=${result.items.pageable.pageNumber + 1},size=${result.items.pageable.pageSize})}" title='Go to next page'>→</a>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </td>
            <td width="20">&nbsp;</td>
            <td>
                <h1 class="widget-header">As the graph</h1>
                <table class="pure-table" id="fragment-metrics-graph-table" th:fragment="fragment-metrics-graph-table">
                    <tbody>
                    <tr>
                        <td width="200">
                            <p id="axes-selected">Axes: </p>
                        </td>
                        <td style="border-left:0">
                            <a class='pure-button' href="#" id='button-draw-plot'
                               th:onclick="${ 'drawPlot();' }"
                               th:text="${'Draw plot'}">Axis for plotting</a>

                        </td>
                    </tr>
                    <tr>
                        <td width="800" id="plot-place" colspan="2">
                            <!--<div id="plot-place" style="width:800px; height:800px;"></div>-->
                        </td>
                    </tr>
                    </tbody>
                </table>
            </td>
        </tr>
    </table>
    <p>&nbsp;</p>


    <table>
        <tr valign="top">
            <td>
                <h1 class="widget-header">Sequences</h1>
                <table class="pure-table pure-table-bordered" id="fragment-table" th:fragment="fragment-table">
                    <thead>
                    <tr>
                        <th>Id</th>
                        <th>Is completed?</th>
                        <th>Is all snippets Ok?</th>
                        <th>Date</th>
                        <th colspan="1">&nbsp;</th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr th:each="s, g : ${result.items}" valign="top">
                        <td th:text="${s.id}">Sequence Id</td>
                        <td th:text="${s.isCompleted}">isCompleted</td>
                        <td th:text="${s.isAllSnippetsOk}">isAllSnippetsOk</td>
                        <td>
                            <table>
                                <tr><td th:text="${'assigned: ' + #dates.format(s.assignedOn, 'dd-MMM-yy HH:mm')}">assigned on></tr>
                                <tr><td th:text="${'completed: ' + #dates.format(s.completedOn, 'dd-MMM-yy HH:mm')}">completed on></tr>
                            </table>
                        </td>
                        <td>
                            <a class='ajax-elem-console table-nav-button pure-button' th:id="${'a-console-'+ g.index}" href="#"
                               th:href="@{/launchpad/experiment-feature-progress-console-part/{id}/(id=${s.id})}"
                               title='Console output'>Info</a>
                    </tr>
                    <tr>
                        <td colspan="6">
                            <div th:if="${feature!=null and experiment!=null}">
                                <ul class='pagination pagination-centered'>
                                    <li class="table-nav-padding">
                                        <span th:if='${result.items.first}' class="table-nav-button">« First</span>
                                        <a class='ajax-elem table-nav-button pure-button prev' href="#" th:if='${not result.items.first}'
                                           th:href="@{/launchpad/experiment-feature-progress-part/{experimentId}/{featureId}/,/part(experimentId=${experiment.id},featureId=${feature.id},page=0,size=${result.items.pageable.pageSize})}">« First</a>
                                    </li>
                                    <li class="table-nav-padding">
                                        <span th:if='${not result.items.hasPrevious()}' class="table-nav-button">←</span>
                                        <a class='ajax-elem table-nav-button pure-button prev' href="#" th:if='${result.items.hasPrevious()}'
                                           th:href="@{/launchpad/experiment-feature-progress-part/{experimentId}/{featureId}/,/part(experimentId=${experiment.id},featureId=${feature.id},page=${result.items.pageable.pageNumber - 1},size=${result.items.pageable.pageSize})}" title='Go to previous page'>←</a>
                                    </li>
                                    <li class="table-nav-padding">
                                        <span th:if='${not result.items.hasNext()}' class="table-nav-button">→</span>
                                        <a class='ajax-elem table-nav-button pure-button prev' href="#" th:if='${result.items.hasNext()}'
                                           th:href="@{/launchpad/experiment-feature-progress-part/{experimentId}/{featureId}/,/part(experimentId=${experiment.id},featureId=${feature.id},page=${result.items.pageable.pageNumber + 1},size=${result.items.pageable.pageSize})}" title='Go to next page'>→</a>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
                <p>&nbsp;</p>

                <a class="pure-button pure-button-primary" href="experiment-info.html" th:href="${'/launchpad/experiment-info/' + experiment.id }">To experiment info</a>

            </td>
            <td width="20">&nbsp;</td>
            <td>
                <h1 class="widget-header">Console output</h1>
                <table class="pure-table pure-table-bordered" id="fragment-console-table" th:fragment="fragment-console-table">
                    <tbody>
                    <div  th:remove="tag" th:each="c, g : ${consoleResult.items}" >
                        <tr th:onclick="${ 'switchTr(''snippet-console-' + c.order +''', ' + c.order +');' }" ><td th:text="${'#'+c.order+', exit code: ' + c.exitCode + ', isOk: ' + c.isOk}">Current state</td></tr>
                        <tr th:style="${ c.order==1 ? 'display:none' : '' }" th:id="${'snippet-console-' + c.order}"><td><pre th:text="${c.console}">console output</pre></td></tr>
                    </div>
                    </tbody>
                </table>
            </td>
        </tr>
    </table>


</div>